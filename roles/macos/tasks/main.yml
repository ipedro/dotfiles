---
# =============================================================================
# Screenshots directory
# =============================================================================
- name: Ensure Screenshots directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/Pictures/Screenshots"
    state: directory
    mode: "0755"

- name: Configure macOS defaults
  community.general.osx_defaults:
    domain: "{{ item.domain }}"
    key: "{{ item.key }}"
    type: "{{ item.type }}"
    value: "{{ item.value }}"
  loop: "{{ macos_defaults }}"
  when: configure_macos_defaults | default(false)

# =============================================================================
# Touch ID for sudo
# =============================================================================
- name: Check if Touch ID PAM module exists
  ansible.builtin.stat:
    path: /usr/lib/pam/pam_tid.so.2
  register: pam_tid

- name: Enable Touch ID for sudo
  become: true
  ansible.builtin.lineinfile:
    path: /etc/pam.d/sudo_local
    line: "auth       sufficient     pam_tid.so"
    create: true
    mode: "0444"
    insertbefore: BOF
  when:
    - pam_tid.stat.exists
    - enable_touchid_sudo | default(true)

# =============================================================================
# Dock Apps Configuration
# =============================================================================
- name: Configure Dock apps
  when: dock_apps is defined and dock_apps | length > 0
  block:
    - name: Clear existing Dock apps
      ansible.builtin.shell: defaults write com.apple.dock persistent-apps -array
      changed_when: true

    - name: Add apps to Dock
      ansible.builtin.shell: |
        defaults write com.apple.dock persistent-apps -array-add \
          "<dict>
            <key>tile-data</key>
            <dict>
              <key>file-data</key>
              <dict>
                <key>_CFURLString</key>
                <string>{{ item.path }}</string>
                <key>_CFURLStringType</key>
                <integer>0</integer>
              </dict>
            </dict>
          </dict>"
      loop: "{{ dock_apps }}"
      changed_when: true

    - name: Restart Dock
      ansible.builtin.command: killall Dock
      changed_when: true

# =============================================================================
# Automated Maintenance (LaunchAgent)
# =============================================================================
- name: Setup automated maintenance
  when: enable_maintenance_schedule | default(true)
  block:
    - name: Ensure log directory exists
      ansible.builtin.file:
        path: "{{ ansible_facts.env.HOME }}/.local/log"
        state: directory
        mode: "0755"

    - name: Install maintenance LaunchAgent
      ansible.builtin.template:
        src: com.pedro.dotfiles.maintenance.plist.j2
        dest: "{{ ansible_facts.env.HOME }}/Library/LaunchAgents/com.pedro.dotfiles.maintenance.plist"
        mode: "0644"
      register: launchagent_installed

    - name: Load maintenance LaunchAgent
      ansible.builtin.command: >
        launchctl load -w {{ ansible_facts.env.HOME }}/Library/LaunchAgents/com.pedro.dotfiles.maintenance.plist
      when: launchagent_installed.changed
      changed_when: true
      failed_when: false

# =============================================================================
# Time Machine Exclusions
# =============================================================================
- name: Configure Time Machine exclusions
  when: timemachine_exclusions is defined and timemachine_exclusions | length > 0
  block:
    - name: Expand exclusion paths
      ansible.builtin.set_fact:
        expanded_exclusions: "{{ timemachine_exclusions | map('regex_replace', '^~', ansible_facts.env.HOME) | list }}"

    - name: Add Time Machine exclusions
      ansible.builtin.command: tmutil addexclusion "{{ item }}"
      loop: "{{ expanded_exclusions }}"
      register: tmutil_result
      changed_when: tmutil_result.rc == 0
      failed_when: false  # Don't fail if path doesn't exist yet
