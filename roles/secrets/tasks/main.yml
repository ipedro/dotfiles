---
# Install and configure Bitwarden CLI
- name: Check if Bitwarden CLI is installed
  ansible.builtin.shell: command -v bw
  register: bw_installed
  failed_when: false
  changed_when: false

- name: Install Bitwarden CLI
  community.general.homebrew:
    name: bitwarden-cli
    state: present
  when: bw_installed.rc != 0

- name: Check Bitwarden login status
  ansible.builtin.shell: bw status | grep -q '"status":"unlocked"'
  register: bw_unlocked
  failed_when: false
  changed_when: false

# Environment secrets (.zshrc.local)
- name: Fetch secrets from Vaultwarden
  ansible.builtin.shell: |
    {% if item.field | default('password') == 'username' %}
    bw get username "{{ item.bw_name }}"
    {% else %}
    bw get password "{{ item.bw_name }}"
    {% endif %}
  args:
    executable: /bin/bash
  loop: "{{ vaultwarden_secrets | default([]) }}"
  register: fetched_secrets
  when: bw_unlocked.rc == 0
  no_log: true

- name: Write secrets to .zshrc.local
  ansible.builtin.template:
    src: zshrc.local.j2
    dest: "{{ ansible_facts.env.HOME }}/.zshrc.local"
    mode: "0600"
  when: bw_unlocked.rc == 0 and fetched_secrets is defined

# Sparkle EdDSA signing key
- name: Check if Sparkle key exists in Keychain
  ansible.builtin.shell: security find-generic-password -s "https://sparkle-project.org" -a "ed25519" 2>/dev/null
  register: sparkle_key_exists
  failed_when: false
  changed_when: false

- name: Fetch Sparkle private key from Vaultwarden
  ansible.builtin.shell: bw get password "{{ sparkle_key.bw_name }}"
  register: sparkle_private_key
  when:
    - bw_unlocked.rc == 0
    - sparkle_key_exists.rc != 0
    - sparkle_key is defined
  no_log: true

- name: Add Sparkle key to Keychain
  ansible.builtin.shell: |
    security add-generic-password \
      -s "https://sparkle-project.org" \
      -a "ed25519" \
      -D "private key" \
      -l "Private key for signing Sparkle updates" \
      -w "{{ sparkle_private_key.stdout }}"
  when:
    - sparkle_private_key is defined
    - sparkle_private_key.stdout is defined
    - sparkle_private_key.stdout | length > 0
  no_log: true

# SSH keys restoration
- name: Fetch SSH private keys from Vaultwarden
  ansible.builtin.shell: bw get notes "{{ item.bw_name }}"
  loop: "{{ ssh_keys | default([]) }}"
  register: fetched_ssh_keys
  when: bw_unlocked.rc == 0
  no_log: true

- name: Write SSH private keys
  ansible.builtin.copy:
    content: "{{ item.stdout }}"
    dest: "{{ ansible_facts.env.HOME }}/.ssh/{{ ssh_keys[idx].filename }}"
    mode: "0600"
  loop: "{{ fetched_ssh_keys.results | default([]) }}"
  loop_control:
    index_var: idx
  when:
    - item.stdout is defined
    - item.stdout | length > 0
  no_log: true
